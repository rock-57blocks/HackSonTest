name: External Trigger Workflow

on:
  # Triggered via API from local server using repository_dispatch
  repository_dispatch:
    types: [run-external-job]

  # Optional: allow manual triggering from the GitHub UI
  workflow_dispatch:
    inputs:
      message:
        description: 'Message from external trigger or manual run'
        required: false
        default: 'Hello from workflow_dispatch'

jobs:
  run-external-job:
    runs-on: ubuntu-latest
    steps:
      - name: Show trigger context
        run: |
          echo "Event name: ${{ github.event_name }}"
          echo "Repository: ${{ github.repository }}"

      - name: Print messages from event
        env:
          DISPATCH_MESSAGE: ${{ github.event.client_payload.message }}
          WORKFLOW_MESSAGE: ${{ github.event.inputs.message }}
        run: |
          echo "Message from repository_dispatch client_payload: ${DISPATCH_MESSAGE:-<none>}"
          echo "Message from workflow_dispatch input: ${WORKFLOW_MESSAGE:-<none>}"

      - name: Do some work
        run: |
          echo "Running external-triggered job..."
          date

      - name: Add comment to Jira ticket
        if: ${{ github.event.client_payload.jira_ticket_url != '' }}
        env:
          JIRA_TICKET_URL: ${{ github.event.client_payload.jira_ticket_url }}
          JIRA_EMAIL: ${{ secrets.JIRA_EMAIL }}
          JIRA_API_TOKEN: ${{ secrets.JIRA_API_TOKEN }}
        run: |
          if [ -z "$JIRA_TICKET_URL" ]; then
            echo "No JIRA_TICKET_URL provided, skipping Jira comment."
            exit 0
          fi

          echo "Jira ticket URL: $JIRA_TICKET_URL"

          # Extract base URL and issue key from a URL like:
          #   https://your-domain.atlassian.net/browse/KEY-123
          JIRA_BASE_URL=$(echo "$JIRA_TICKET_URL" | sed -E 's#(https?://[^/]+)/.*#\1#')
          ISSUE_KEY=$(echo "$JIRA_TICKET_URL" | sed -E 's#.*/browse/([^/?]+).*#\1#')

          if [ -z "$ISSUE_KEY" ] || [ -z "$JIRA_BASE_URL" ]; then
            echo "Failed to extract Jira base URL or issue key from: $JIRA_TICKET_URL"
            exit 1
          fi

          if [ -z "$JIRA_EMAIL" ] || [ -z "$JIRA_API_TOKEN" ]; then
            echo "Missing Jira credentials. Please set JIRA_EMAIL and JIRA_API_TOKEN secrets."
            exit 1
          fi

          AUTH=$(printf '%s:%s' "$JIRA_EMAIL" "$JIRA_API_TOKEN" | base64)

          echo "Commenting on Jira issue $ISSUE_KEY at $JIRA_BASE_URL"

          COMMENT_BODY='{"body":"This is a test comment posted from GitHub Actions workflow."}'

          curl -sS -X POST \
            -H "Authorization: Basic $AUTH" \
            -H "Content-Type: application/json" \
            "$JIRA_BASE_URL/rest/api/3/issue/$ISSUE_KEY/comment" \
            -d "$COMMENT_BODY"

      - name: Send notification email
        uses: dawidd6/action-send-mail@v3
        with:
          # TODO: Replace these SMTP settings with your real mail server
          server_address: ${{ secrets.SMTP_SERVER_ADDRESS }}
          server_port: ${{ secrets.SMTP_SERVER_PORT }}
          username: ${{ secrets.SMTP_USERNAME }}
          password: ${{ secrets.SMTP_PASSWORD }}
          secure: true

          subject: "This is a test email from github action (Harry Potter hackSon team)"
          to: "rchen@ext.liftoff.io"
          from: "GitHub Actions <no-reply@example.com>"
          body: |
            This is a test email that test workflow
